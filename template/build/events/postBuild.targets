<Project>
    <PropertyGroup>
        <PostWaitSeconds Condition="'$(IsMultiplayerTest)' == 'true'">5</PostWaitSeconds>
        <PostWaitSeconds Condition="'$(IsMultiplayerTest)' != 'true'">1</PostWaitSeconds>
        
        <!-- Python postbuild script location -->
        <PostBuildScript>"$(MSBuildProjectDirectory)\build\events\postbuild.py"</PostBuildScript>
        
        <!-- Unix/Wine configuration -->
        <WineBinary Condition="'$(OS)' != 'Windows_NT' and '$(WineBinary)' == ''">wine</WineBinary>
        <WinePrefix Condition="'$(OS)' != 'Windows_NT' and '$(WinePrefix)' == ''"></WinePrefix>
    </PropertyGroup>

    <Target Name="DetectS1API" BeforeTargets="PostBuild">
        <!-- Check if S1API is referenced (either as assembly or NuGet package) -->
        <ItemGroup>
            <S1APIReferenceCheck Include="@(Reference)" Condition="$([System.String]::Copy('%(Identity)').StartsWith('S1API'))" />
            <S1APIPackageCheck Include="@(PackageReference)" Condition="$([System.String]::Copy('%(Identity)').StartsWith('S1API'))" />
        </ItemGroup>
        
        <PropertyGroup>
            <HasS1APIReference Condition="'@(S1APIReferenceCheck)' != '' or '@(S1APIPackageCheck)' != ''">true</HasS1APIReference>
        </PropertyGroup>
        
        <Message Condition="'$(HasS1APIReference)' == 'true'" Text="S1API reference detected" Importance="normal" />
    </Target>

    <Target Name="PostBuild" AfterTargets="PostBuildEvent" Condition="'$(RunPostBuildEvent)' == 'OnBuildSuccess'" DependsOnTargets="DetectS1API">
        <Message Text="Running post-build script..." Importance="high" />
        
        <!-- Base arguments -->
        <PropertyGroup>
            <PostBuildArgs>"$(TargetPath)" "$(S1ModsDir)" "$(S1ExePath)"</PostBuildArgs>
            <PostBuildArgs>$(PostBuildArgs) --project-dir "$(MSBuildProjectDirectory)"</PostBuildArgs>
            <PostBuildArgs>$(PostBuildArgs) --wait-seconds $(PostWaitSeconds)</PostBuildArgs>
        </PropertyGroup>
        
        <!-- Add user mods from ModList -->
        <PropertyGroup Condition="'@(ModList)' != ''">
            <PostBuildArgs>$(PostBuildArgs) @(ModList -> '--mod "%(Identity)"', ' ')</PostBuildArgs>
        </PropertyGroup>
        
        <!-- Add multiplayer mods if enabled -->
        <PropertyGroup Condition="'$(IsMultiplayerTest)' == 'true'">
            <PostBuildArgs>$(PostBuildArgs) --mp-mod "$(MultiplayerMod)"</PostBuildArgs>
            <PostBuildArgs>$(PostBuildArgs) --mp-starter "$(MultiplayerModStarter)"</PostBuildArgs>
        </PropertyGroup>
        
        <!-- Add UnityExplorer if enabled -->
        <PropertyGroup Condition="'$(IsUnityExplorer)' == 'true'">
            <PostBuildArgs>$(PostBuildArgs) --unity-explorer-path "$(UnityExplorer)"</PostBuildArgs>
        </PropertyGroup>
        
        <!-- Add S1API if it is referenced -->
        <PropertyGroup Condition="'$(HasS1APIReference)' == 'true'">
            <PostBuildArgs>$(PostBuildArgs) --s1api-path "$(S1API)"</PostBuildArgs>
        </PropertyGroup>
        
        <!-- Add debug flag if DEBUG is defined -->
        <PropertyGroup Condition="$(DefineConstants.Contains('DEBUG'))">
            <PostBuildArgs>$(PostBuildArgs) --debug</PostBuildArgs>
        </PropertyGroup>
        
        <!-- Add Wine args on non-Windows -->
        <PropertyGroup Condition="'$(OS)' != 'Windows_NT'">
            <PostBuildArgs>$(PostBuildArgs) --wine-binary "$(WineBinary)"</PostBuildArgs>
            <PostBuildArgs Condition="'$(WinePrefix)' != ''">$(PostBuildArgs) --wine-prefix "$(WinePrefix)"</PostBuildArgs>
        </PropertyGroup>
        
        <Exec Command="uv run --script $(PostBuildScript) $(PostBuildArgs)" ConsoleToMsBuild="true" EchoOff="false" />
    </Target>
</Project>